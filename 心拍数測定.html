<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pulse Cam - 心拍数測定</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #fafafa; color: #333; }
    video { width: 80%; max-width: 400px; border-radius: 12px; margin-top: 1em; }
    canvas { display: none; }
    button, input { margin: 8px; padding: 10px 20px; border-radius: 8px; border: none; background: #4caf50; color: white; font-size: 16px; }
    button:hover { background: #45a049; }
    input[type='number'] { width: 80px; text-align: center; color: #333; background: #fff; border: 1px solid #ccc; }
    #graph { width: 80%; max-width: 500px; height: 200px; margin: 1em auto; border: 1px solid #ddd; background: #fff; }
  </style>
</head>
<body>
  <h1>Pulse Cam - 心拍数測定</h1>
  <p>スマホのカメラとライトを使用して心拍数を測定します。</p>
  <label>測定時間（秒）: <input type="number" id="durationInput" value="420" min="10" max="900"></label><br>
  <button id="startBtn">測定開始</button>
  <button id="stopBtn" disabled>停止</button>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
  <div id="graph"></div>
  <p id="result"></p>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const result = document.getElementById('result');
    const durationInput = document.getElementById('durationInput');
    const graph = document.getElementById('graph');

    let stream, recording = false, data = [], startTime;

    async function startMeasurement() {
      const duration = parseInt(durationInput.value) * 1000; // ms
      data = [];
      result.textContent = '';
      graph.innerHTML = '';

      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        const track = stream.getVideoTracks()[0];
        const imageCapture = new ImageCapture(track);
        try { await track.applyConstraints({ advanced: [{ torch: true }] }); } catch {}

        recording = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        startTime = Date.now();
        measureLoop(imageCapture, duration);
      } catch (e) {
        alert('カメラへのアクセスが許可されていません。');
      }
    }

    async function measureLoop(imageCapture, duration) {
      if (!recording) return;
      const img = await imageCapture.grabFrame();
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      const pixels = ctx.getImageData(0, 0, img.width, img.height).data;
      let sum = 0;
      for (let i = 0; i < pixels.length; i += 4) sum += pixels[i]; // 赤成分平均
      data.push({ time: Date.now() - startTime, red: sum / (pixels.length / 4) });

      drawGraph();

      if (Date.now() - startTime < duration) {
        requestAnimationFrame(() => measureLoop(imageCapture, duration));
      } else {
        stopMeasurement();
      }
    }

    function stopMeasurement() {
      recording = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      if (stream) stream.getTracks().forEach(t => t.stop());
      if (data.length > 0) {
        analyzePulse();
        exportCSV();
      }
    }

    function analyzePulse() {
      const reds = data.map(d => d.red);
      let peaks = 0;
      for (let i = 1; i < reds.length - 1; i++) {
        if (reds[i] > reds[i - 1] && reds[i] > reds[i + 1]) peaks++;
      }
      const seconds = (data[data.length - 1].time - data[0].time) / 1000;
      const bpm = Math.round((peaks / seconds) * 60);
      result.textContent = `推定心拍数: ${bpm} BPM`;
    }

    function exportCSV() {
      let csv = 'time(ms),red\n';
      data.forEach(d => csv += `${d.time},${d.red}\n`);
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'pulse_data.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function drawGraph() {
      const ctx2 = graph.getContext ? graph.getContext('2d') : null;
      if (!ctx2) {
        const cvs = document.createElement('canvas');
        cvs.width = graph.clientWidth;
        cvs.height = graph.clientHeight;
        graph.appendChild(cvs);
        drawGraph();
        return;
      }
      ctx2.clearRect(0, 0, graph.clientWidth, graph.clientHeight);
      const reds = data.slice(-100).map(d => d.red);
      if (reds.length < 2) return;
      const min = Math.min(...reds), max = Math.max(...reds);
      ctx2.beginPath();
      reds.forEach((r, i) => {
        const x = (i / reds.length) * graph.clientWidth;
        const y = graph.clientHeight - ((r - min) / (max - min)) * graph.clientHeight;
        if (i === 0) ctx2.moveTo(x, y); else ctx2.lineTo(x, y);
      });
      ctx2.strokeStyle = '#e91e63';
      ctx2.lineWidth = 2;
      ctx2.stroke();
    }

    startBtn.onclick = startMeasurement;
    stopBtn.onclick = stopMeasurement;
  </script>
</body>
</html>